# 业务逻辑汇总

## Client
Client端实现多个功能
1.节点注册（基础）
2.服务管理（基础）
3.用户注册（基础）
4.链交互（扩展）
这些功能，依赖Server端来提供一些关键API
会在http://localhost:3008/显示相关交互页面（开发环境）

## Server
Server端目前计划实现的关键API（basic和extend）
请参考data/service_list.json
服务于client端
Basic包括：
1.节点注册
2.服务管理
3.用户注册
扩展服务包括：
4.链交互
5.资产发行/Asset
6.去中心论坛
7.DComment
8.GameX
9.ItemFlow
10.AI Agent/Doggy
更多参考[notion](https://www.notion.so/cmuba/AAStar-Q4-Plan-1466900e50b6806daac7d86da7c64951)

### 节点注册逻辑
1. 所有人都可以自己clone代码或者使用docker来运行一个社区节点。
2. 社区节点内运行的是必须和可选服务，根据自己情况调整。
3. 社区节点担负了社区计算网络的职责，为协议的运作提供计算支撑，因此，设计了节点的安全注册机制。
4. 所有节点都要自己生成一个key pair，用于加密和签名。
5. 所有节点都要到协议约定的无主合约内注册自己的公钥和地址
6. 而每次链上交互，都需要通过约定的私钥签名来验证，确保安全。
7. 注册你的节点之前，需要stake协议的治理token，stake后，node registry才会允许注册。
8. 注册后，进入协议的节点发现服务范围，对外提供计算服务。
9. 未来会提供计算reward机制，一键运行docker镜像，服务down机的slash（超过一周开始slash），节点退出。
10. 所有节点的stake额度由社区投票通过，可以进行年度调整，不会因为stake而获利，stake是质押提供的安全保障。
11. 获利是因为你提供的去中心节点的计算服务而获得社区流动代币PNTs。

### 服务管理逻辑
1. 目前所有服务由NodeJs开发，未来会调整为Nextjs+Go的不同镜像服务。
2. 服务管理是为了提供服务发现、去中心服务调用路径和服务健康检查等功能，目前完成了服务发现（部分）。
3. Node registry提供了node的注册功能，依赖于约定的服务list，node可以快速注册服务。
4. 但服务如何发现并使用？是否有效？是否一直健康？采用什么方式调用？是服务管理要提供的基础服务。
5. 基于合约内对不同节点的注册信息，我们可以提供基础的服务发现能力。
6. 而基于发现的各个服务的路径，例如组合registry的IP/Domain+API index+约定的API service list，我们可以产生每个节点可以调用的所有接口URI，然后每个接口，提供一个healthcheck的接口，约定health的返回值，就可以实现节点健康检查了。
7. P2P和检查人：因为是去中心，所以健康检查没有中心节点，需要各个节点自己实现，目前计划是每个节点每小时完成一次健康检查服务，然后提交到合约，同时有多个节点进行健康检查，而合约会对外提供一个综合健康检查的结果，用于外部client节点知道调用哪些健康节点来计算。
8. 每个节点会每小时缓存一次合约的健康list，这个list也会包含例如服务区域，服务价格等信息。

### 用户注册逻辑
1. 这个部分是AirAccount体系来实现，目标是每个人都用于一个去中心化的，self-custody，简单易用的加密账户。
2. AirAccount是一个建立在以太坊的账户，但是它是去中心化的，没有中心化的节点，只是一个数据映射。
3. 基于ERC4337和EIP7702以及未来的EIP7560,我们会提供二次签名验证的，无gas的，social account绑定的，多签恢复的，执行遗嘱的，有日限额和子账户的加密账户。
4. 而用户注册的逻辑，就是用户在社区节点上创建一个AirAccount，然后注册成为用户，这个AirAccount就是用户的身份证，用于在社区节点上进行身份验证和身份授权。
5. 你可以随时搬家，如果对社区不满意或者不便利，甚至可以自己运行一个社区节点。
6. AirAccount底层服务是Go开发的，作为社区镜像节点的一部分，你需要运行这个服务。
7. 内部逻辑是credential（例如email，social account等）+你的指纹，注册到一个社区节点，产生一个key pair，这个key pair可以用于后续的身份验证和授权。基于TEE运行的社区阶段，只能操作你的私钥做你允许的行为。
8. 因为二次签名验证，所以每次都需要你的指纹验证签名，才可以真正的支配你的链上资产，很适合社区资产的管理，简单，安全。
9. 描述下外部使用流程：访问client页面，采用google授权登录或者twitter，或者email验证，然后输入你的指纹，完成注册。
10. 注册成功后，你可以登录你的社区账户，使用社区节点的计算服务，因为第一次验证服务由社区节点提供，所以社区节点要确保24小时运行。
11. 当然你可以在client首页选择搬家：去另外一个社区节点生成新的一次验证密钥，地址不变，但私钥变更。
12. 使用AirAccount可以在社区产品和兼容1271的DApp上，进行无gas的顺畅体验。

## ChainX
单独把ChainX，链交互领出来，因为比较专业。
基于AirAccount和相关以太坊协议，我们需要构建交易，提交给bundler（未来会升级），然后上链。
包括链的查询、事件订阅等等。
因此我们需要一个基础服务，client端提供chainId，交互内容，二次签名等内容，server端负责上链并返回交易hash（或者其他）。
而链服务要维护一个请求映射关系，确保不同的链，提交到不同的bundler，不同rpc。
而订阅的监听，也需要转发到不同client上。
先完成GameX部分，chainid，三个核心接口，node签名，用户二次签名（还没接入account）

### GameX/Contract
合约部分是为了实现链交互而提供的业务层，底层是为用户的链上数据交互提供接口。
未来用户注册的底层接口，也依赖contract部分来实现。
在这里，合约就代表了区块链的交互，不仅仅是合约的意思。

目前合约部分主要是Game的合约交互实现：
- `HeroNFT`: 负责英雄 NFT 的铸造和管理，基于 Aptos Token 标准
- `HeroMetadata`: 负责英雄元数据（技能、种族、职业）的管理
- `Hero`: 核心模块，负责英雄数据的创建、加载和保存


### GameX：Game玩家使用逻辑

用户（玩家）需要先购买 HeroNFT，然后才可以创建 hero 记录。
HeroNFT 是所有用户必须先购买的 官方 NFT 合约，属于（collection）合约 的 NFT，才可以在 Hero 合约创建新 hero。
管理员（合约发布者）可以调用 Hero 合约接口，新增许可的 NFT 合约，然后用户就可以使用这些 外部 NFT 在 Hero 合约创建 hero 记录。

HeroMetadata 是静态数据表，存储一些技能计算数据，种族和职业设定等，在部署后需要部署者初始化这个数据，然后以读取为主（也可能会维护）

Hero 是核心英雄数据结构，包括基本属性，技能数据表等，另外会有一个 NFT 合约注册表，只有在此注册表的 NFT，才可以新增 hero 记录，部署者可以给 NFT 注册表新增 NFT 合约（collection）。
