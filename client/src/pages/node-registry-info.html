<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>节点注册合约信息 - Arcadia Node</title>
    <link rel="stylesheet" href="/css/common.css">
    <script src="/js/ethers.umd.min.js"></script>
    <style>
        .node-list {
            margin-top: 20px;
        }
        .node-item {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .node-item h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .node-detail {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
            margin-bottom: 5px;
        }
        .node-detail .label {
            font-weight: bold;
            color: #666;
        }
        .node-detail .value {
            word-break: break-all;
        }
        .refresh-btn {
            margin-bottom: 20px;
        }
        .search-section {
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        .search-form {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .search-form input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-form button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .search-form button:hover {
            background: #45a049;
        }
        .error {
            color: #f44336;
            padding: 10px;
            margin: 10px 0;
            background: #ffebee;
            border-radius: 4px;
        }
        .no-nodes {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>节点注册合约信息</h1>
            <a href="/index.html" class="back-link">返回首页</a>
        </div>
    </div>

    <div class="container">
        <h1>节点注册信息</h1>
        <div class="info-section">
            <p>合约地址：<span id="contractAddress">加载中...</span></p>
            <p>状态：<span id="status">正在连接...</span></p>
        </div>
        
        <div class="search-section">
            <h2>查询节点信息</h2>
            <div class="search-form">
                <input type="text" id="nodeAddress" placeholder="输入节点地址" />
                <button onclick="checkNodeAddress()">查询</button>
            </div>
        </div>

        <div class="node-list-section">
            <h2>已注册节点列表</h2>
            <button onclick="refreshNodeList()">刷新节点列表</button>
            <div id="nodeList" class="node-list"></div>
        </div>
    </div>

    <script>
        let provider;
        let contract;
        const nodeRegistryAbi = [
            "function getNodeInfo(address nodeAddress) view returns (string ipOrDomain, string apiIndexes, uint256 registeredAt)",
            "function isRegistered(address nodeAddress) view returns (bool)",
            "function validateStake(address nodeAddress) view returns (bool)"
        ];

        async function initContract() {
            try {
                // 获取合约地址
                const response = await fetch('/api/v1/env/get', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        key: 'NODE_REGISTRY_ADDRESS'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch contract address');
                }

                const data = await response.json();
                if (data.code !== 0 || !data.value) {
                    throw new Error('Invalid response format or missing contract address');
                }

                const contractAddress = data.value;
                document.getElementById('contractAddress').textContent = contractAddress;

                // 初始化 provider 和合约
                provider = new ethers.JsonRpcProvider('https://sepolia.optimism.io');
                contract = new ethers.Contract(contractAddress, nodeRegistryAbi, provider);
                
                document.getElementById('status').textContent = '已连接';
                
                // 加载初始数据
                await refreshNodeList();
            } catch (error) {
                console.error('初始化失败：', error);
                document.getElementById('status').textContent = '连接失败: ' + error.message;
            }
        }

        async function checkNodeAddress() {
            const address = document.getElementById('nodeAddress').value;
            if (!ethers.isAddress(address)) {
                alert('请输入有效的地址');
                return;
            }

            try {
                const isRegistered = await contract.isRegistered(address);
                if (!isRegistered) {
                    alert('该地址未注册为节点');
                    return;
                }

                const [ipOrDomain, apiIndexes, registeredAt] = await contract.getNodeInfo(address);
                const hasValidStake = await contract.validateStake(address);

                const searchResult = document.createElement('div');
                searchResult.className = 'node-item';
                searchResult.innerHTML = `
                    <div class="node-header">
                        <h3>查询结果</h3>
                    </div>
                    <div class="node-details">
                        <div class="node-detail">
                            <span class="label">地址：</span>
                            <span class="value">${address}</span>
                        </div>
                        <div class="node-detail">
                            <span class="label">域名/IP：</span>
                            <span class="value">${ipOrDomain}</span>
                        </div>
                        <div class="node-detail">
                            <span class="label">API 索引：</span>
                            <span class="value">${apiIndexes}</span>
                        </div>
                        <div class="node-detail">
                            <span class="label">注册时间：</span>
                            <span class="value">${new Date(Number(registeredAt) * 1000).toLocaleString()}</span>
                        </div>
                        <div class="node-detail">
                            <span class="label">质押状态：</span>
                            <span class="value" style="color: ${hasValidStake ? '#4CAF50' : '#f44336'}">${hasValidStake ? '有效' : '无效'}</span>
                        </div>
                    </div>
                `;

                const nodeList = document.getElementById('nodeList');
                nodeList.innerHTML = '';
                nodeList.appendChild(searchResult);
            } catch (error) {
                console.error('查询节点信息失败：', error);
                alert('查询失败：' + error.message);
            }
        }

        async function refreshNodeList() {
            try {
                // 获取所有已注册的节点地址
                const nodeList = document.getElementById('nodeList');
                nodeList.innerHTML = '';

                // 从本地存储获取最近的地址
                const recentAddresses = JSON.parse(localStorage.getItem('recentAddresses') || '[]');
                
                for (const address of recentAddresses) {
                    const isRegistered = await contract.isRegistered(address);
                    if (!isRegistered) continue;

                    const [ipOrDomain, apiIndexes, registeredAt] = await contract.getNodeInfo(address);
                    const hasValidStake = await contract.validateStake(address);

                    const nodeItem = document.createElement('div');
                    nodeItem.className = 'node-item';
                    nodeItem.innerHTML = `
                        <div class="node-header">
                            <h3>节点信息</h3>
                        </div>
                        <div class="node-details">
                            <div class="node-detail">
                                <span class="label">地址：</span>
                                <span class="value">${address}</span>
                            </div>
                            <div class="node-detail">
                                <span class="label">域名/IP：</span>
                                <span class="value">${ipOrDomain}</span>
                            </div>
                            <div class="node-detail">
                                <span class="label">API 索引：</span>
                                <span class="value">${apiIndexes}</span>
                            </div>
                            <div class="node-detail">
                                <span class="label">注册时间：</span>
                                <span class="value">${new Date(Number(registeredAt) * 1000).toLocaleString()}</span>
                            </div>
                            <div class="node-detail">
                                <span class="label">质押状态：</span>
                                <span class="value" style="color: ${hasValidStake ? '#4CAF50' : '#f44336'}">${hasValidStake ? '有效' : '无效'}</span>
                            </div>
                        </div>
                    `;
                    nodeList.appendChild(nodeItem);
                }

                if (nodeList.children.length === 0) {
                    nodeList.innerHTML = '<div class="no-nodes">暂无注册节点</div>';
                }
            } catch (error) {
                console.error('刷新节点列表失败：', error);
                document.getElementById('nodeList').innerHTML = `<div class="error">加载失败：${error.message}</div>`;
            }
        }

        // 页面加载时初始化
        window.addEventListener('load', initContract);
    </script>
</body>
</html> 