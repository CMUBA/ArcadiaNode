<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>节点注册 - Arcadia Node</title>
    <link rel="stylesheet" href="/css/common.css">
    <script type="module">
        import { ethers } from 'ethers';
        import { api } from '../api/index.js';

        // 导出到全局，以便按钮事件可以访问
        window.generateNewKeypair = async () => {
            try {
                // 生成新的随机钱包
                const wallet = ethers.Wallet.createRandom();
                
                // 显示新节点信息
                document.getElementById('newNodeAddress').value = wallet.address;
                document.getElementById('newNodePrivateKey').value = wallet.privateKey;
                
                // 清空之前的结果
                document.getElementById('challenge').value = '';
                document.getElementById('signature').value = '';
                document.getElementById('challengeResult').textContent = '';
                document.getElementById('signResult').textContent = '';
                document.getElementById('registerResult').textContent = '';
                document.getElementById('nodeEns').value = '';

                return wallet;
            } catch (error) {
                console.error('生成密钥对失败:', error);
                throw error;
            }
        };

        window.getChallenge = async () => {
            try {
                const response = await api.node.getChallenge();
                const data = await response.json();
                
                if (data.code === 0 && data.data && data.data.challenge) {
                    document.getElementById('challenge').value = data.data.challenge;
                    document.getElementById('challengeResult').textContent = '获取 Challenge 成功';
                } else {
                    document.getElementById('challengeResult').textContent = '获取 Challenge 失败: ' + (data.message || '未知错误');
                }
            } catch (error) {
                document.getElementById('challengeResult').textContent = 'Error: ' + error.message;
            }
        };

        window.signChallenge = async () => {
            try {
                const challenge = document.getElementById('challenge').value;
                if (!challenge) {
                    throw new Error('请先获取 Challenge');
                }

                const privateKey = document.getElementById('newNodePrivateKey').value;
                if (!privateKey) {
                    throw new Error('请先生成新节点密钥对');
                }

                // 使用私钥创建钱包实例
                const wallet = new ethers.Wallet(privateKey);
                
                // 签名消息
                const signature = await wallet.signMessage(challenge);
                
                document.getElementById('signature').value = signature;
                document.getElementById('signResult').textContent = '签名成功';
            } catch (error) {
                document.getElementById('signResult').textContent = 'Error: ' + error.message;
            }
        };

        window.registerNode = async () => {
            try {
                const nodeAddress = document.getElementById('newNodeAddress').value;
                const nodeEndpoint = document.getElementById('nodeEndpoint').value;
                const nodeApis = document.getElementById('nodeApis').value;
                const challenge = document.getElementById('challenge').value;
                const signature = document.getElementById('signature').value;
                const nodeEns = document.getElementById('nodeEns').value;

                if (!nodeAddress || !nodeEndpoint || !nodeApis || !challenge || !signature) {
                    throw new Error('请填写所有必要信息');
                }

                // 构建请求数据
                const requestData = {
                    node_address: nodeAddress,
                    node_url: nodeEndpoint,
                    api_url: `${nodeEndpoint}/api/v1`,
                    node_ens: nodeEns || '',
                    node_ip: '',
                    node_service_list: nodeApis,
                    challenge,
                    signature
                };

                // 显示请求信息
                document.getElementById('requestResponseCard').style.display = 'block';
                document.getElementById('requestInfo').textContent = JSON.stringify(requestData, null, 2);

                // 发送注册请求
                const response = await api.node.register(requestData);
                const responseData = await response.json();

                // 显示响应信息
                document.getElementById('responseInfo').textContent = JSON.stringify(responseData, null, 2);

                // 更新注册结果显示
                const registerResult = document.getElementById('registerResult');
                if (response.ok && responseData.code === 0) {
                    registerResult.innerHTML = `
                        <div class="success-message">
                            注册成功！<br>
                            节点地址: ${nodeAddress}<br>
                            请保存新节点私钥：${document.getElementById('newNodePrivateKey').value}
                        </div>
                    `;

                    // 保存新注册的地址到本地存储
                    const recentAddresses = JSON.parse(localStorage.getItem('recentAddresses') || '[]');
                    if (!recentAddresses.includes(nodeAddress)) {
                        recentAddresses.push(nodeAddress);
                        localStorage.setItem('recentAddresses', JSON.stringify(recentAddresses));
                    }

                    // 添加交易链接
                    const txHash = responseData.tx_hash;
                    registerResult.innerHTML += `
                        <div class="transaction-info">
                            <p>交易哈希: ${txHash}</p>
                            <p>查看交易: <a href="https://sepolia-optimism.etherscan.io/tx/${txHash}" target="_blank">Etherscan</a></p>
                        </div>
                    `;
                } else {
                    registerResult.innerHTML = `
                        <div class="error-message">
                            注册失败：${responseData.message || '未知错误'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('注册节点失败：', error);
                document.getElementById('registerResult').innerHTML = `
                    <div class="error-message">
                        注册失败：${error.message}
                    </div>
                `;
                document.getElementById('responseInfo').textContent = `Error: ${error.message}`;
            }
        };

        // 初始化页面
        window.addEventListener('load', () => {
            // 设置默认值
            document.getElementById('nodeEndpoint').value = 'node.cmuba.org';
            document.getElementById('nodeApis').value = '[1,2,3,4,5,6,7,8,9,10,11,12,13]';
        });
    </script>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>节点注册</h1>
            <a href="/" class="back-link">返回首页</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>新节点信息</h2>
            <div class="form-group">
                <label for="newNodeAddress">新节点地址：</label>
                <input type="text" id="newNodeAddress" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="newNodePrivateKey">新节点私钥：</label>
                <input type="text" id="newNodePrivateKey" class="form-control" readonly>
                <small class="text-muted">请保存此私钥，它只会显示一次！</small>
            </div>
            <div class="form-group">
                <label for="nodeEndpoint">节点 IP/域名：</label>
                <input type="text" id="nodeEndpoint" class="form-control" placeholder="例如: https://example.com">
            </div>
            <div class="form-group">
                <label for="nodeApis">API 索引：</label>
                <input type="text" id="nodeApis" class="form-control" placeholder="例如: [1,2,3,4,5]">
            </div>
            <div class="form-group">
                <label for="nodeEns">节点 ENS：</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="nodeEns" class="form-control" placeholder="TODO" readonly style="background-color: #f5f5f5;">
                </div>
            </div>
            <button class="btn" onclick="generateNewKeypair()">生成新密钥对</button>
        </div>

        <div class="card">
            <h2>获取 Challenge</h2>
            <button class="btn" onclick="getChallenge()">获取 Challenge</button>
            <div id="challengeResult" class="result"></div>
        </div>

        <div class="card">
            <h2>签名 Challenge</h2>
            <div class="form-group">
                <label for="challenge">Challenge：</label>
                <input type="text" id="challenge" class="form-control" readonly>
            </div>
            <button class="btn" onclick="signChallenge()">签名 Challenge</button>
            <div id="signResult" class="result"></div>
        </div>

        <div class="card">
            <h2>注册节点</h2>
            <div class="form-group">
                <label for="signature">签名：</label>
                <input type="text" id="signature" class="form-control" readonly>
            </div>
            <button class="btn" onclick="registerNode()">注册节点</button>
            <div id="registerResult" class="result"></div>
        </div>

        <!-- 请求和响应信息显示区域 -->
        <div class="card" id="requestResponseCard" style="display: none;">
            <h2>请求和响应信息</h2>
            <div class="info-section">
                <h3>请求信息</h3>
                <pre id="requestInfo" class="code-block"></pre>
            </div>
            <div class="info-section">
                <h3>响应信息</h3>
                <pre id="responseInfo" class="code-block"></pre>
            </div>
        </div>
    </div>

    <style>
        /* 添加新的样式 */
        .info-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .info-section h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }
        .code-block {
            background: #fff;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            overflow-x: auto;
            margin: 0;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success-message {
            color: #4CAF50;
            font-weight: bold;
        }
        .error-message {
            color: #f44336;
            font-weight: bold;
        }
    </style>
</body>
</html> 