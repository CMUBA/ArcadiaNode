<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hero System Test - Arcadia Node</title>
    <link rel="stylesheet" href="/css/common.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script type="module">
        import { ethers } from 'ethers';
        import api from '../utils/api.js';
        import { heroConfig } from '../config/hero.js';
        import enLang from '../config/i18n/en.js';
        import zhLang from '../config/i18n/zh.js';
        import thLang from '../config/i18n/th.js';
        import { heroAbi } from '../js/abi/hero.js';
        import { heroMetadataAbi } from '../js/abi/heroMetadata.js';

        const translations = {
            en: enLang,
            zh: zhLang,
            th: thLang
        };

        let currentLang = localStorage.getItem('language') || 'en';
        let provider;
        let signer;
        let heroContract;
        let heroMetadataContract;
        let userAddress;

        // 连接钱包
        async function connectWallet() {
            try {
                // 请求用户授权
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                userAddress = accounts[0];
                
                // 获取 signer
                signer = await provider.getSigner();
                
                // 使用 signer 重新连接合约
                heroContract = heroContract.connect(signer);
                heroMetadataContract = heroMetadataContract.connect(signer);
                
                // 检查网络
                const network = await provider.getNetwork();
                if (network.chainId !== BigInt(heroConfig.ethereum.chainId)) {
                    // 请求切换到 Optimism Sepolia
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + heroConfig.ethereum.chainId.toString(16) }],
                        });
                    } catch (switchError) {
                        // 如果网络不存在，添加网络
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x' + heroConfig.ethereum.chainId.toString(16),
                                    chainName: 'Optimism Sepolia',
                                    nativeCurrency: {
                                        name: 'ETH',
                                        symbol: 'ETH',
                                        decimals: 18
                                    },
                                    rpcUrls: [heroConfig.ethereum.nodeUrl],
                                    blockExplorerUrls: ['https://sepolia-optimism.etherscan.io/']
                                }],
                            });
                        }
                    }
                }

                // 更新 UI
                document.getElementById('connectWallet').style.display = 'none';
                document.getElementById('connectedWallet').style.display = 'block';
                document.getElementById('walletAddress').textContent = userAddress;
                
                // 启用所有需要钱包的按钮
                document.querySelectorAll('.requires-wallet').forEach(button => {
                    button.disabled = false;
                });

                console.log('Wallet connected successfully:', userAddress);
            } catch (error) {
                console.error('连接钱包失败：', error);
                alert('Failed to connect wallet: ' + error.message);
            }
        }

        function updateContent() {
            const t = translations[currentLang];
            
            // Update page title
            document.title = t.hero.test.title;

            // Update wallet section
            if (document.getElementById('walletTitle')) {
                document.getElementById('walletTitle').textContent = t.hero.test.wallet.title;
            }
            if (document.getElementById('connectWallet')) {
                document.getElementById('connectWallet').textContent = t.hero.test.wallet.connect;
            }

            // Update race section
            if (document.getElementById('raceTitle')) {
                document.getElementById('raceTitle').textContent = t.hero.test.race.title;
            }

            // Update class section
            if (document.getElementById('classTitle')) {
                document.getElementById('classTitle').textContent = t.hero.test.class.title;
            }

            // Update skill section
            if (document.getElementById('skillTitle')) {
                document.getElementById('skillTitle').textContent = t.hero.test.skill.title;
            }

            // Update creation section
            if (document.getElementById('creationTitle')) {
                document.getElementById('creationTitle').textContent = t.hero.test.creation.title;
            }

            // Update language selector
            if (document.getElementById('languageSelect')) {
                document.getElementById('languageSelect').value = currentLang;
            }
        }

        window.changeLanguage = function(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            updateContent();
        };

        // 等待所有脚本加载完成
        window.addEventListener('load', async () => {
            try {
                // 初始化 provider
                if (window.ethereum) {
                    provider = new ethers.BrowserProvider(window.ethereum);
                    
                    // 初始化合约
                    heroContract = new ethers.Contract(
                        heroConfig.ethereum.contracts.hero,
                        heroAbi,
                        provider
                    );

                    heroMetadataContract = new ethers.Contract(
                        heroConfig.ethereum.contracts.heroMetadata,
                        heroMetadataAbi,
                        provider
                    );

                    console.log('Contracts initialized successfully');

                    // 绑定连接钱包事件
                    const connectWalletBtn = document.getElementById('connectWallet');
                    if (connectWalletBtn) {
                        connectWalletBtn.addEventListener('click', connectWallet);
                        console.log('Wallet connect button event listener added');
                    }
                } else {
                    console.error('Please install MetaMask!');
                    alert('Please install MetaMask to use this dApp');
                }

                // 更新页面文本
                updateContent();
                
                // 设置其他按钮事件
                document.getElementById('getRaceData')?.addEventListener('click', getRaceData);
                document.getElementById('getClassData')?.addEventListener('click', getClassData);
                document.getElementById('getSkillData')?.addEventListener('click', getSkillData);
                document.getElementById('createHero')?.addEventListener('click', createNewHero);

                // 设置语言选择事件
                document.getElementById('languageSelect')?.addEventListener('change', (e) => {
                    changeLanguage(e.target.value);
                });
            } catch (error) {
                console.error('初始化失败：', error);
                alert('初始化失败：' + error.message);
            }
        });

        // 获取种族数据
        async function getRaceData() {
            try {
                const raceId = document.getElementById('raceId').value;
                const raceData = await heroMetadataContract.getRace(raceId);
                document.getElementById('raceResult').innerHTML = `
                    <div class="mt-4 p-4 bg-gray-100 rounded">
                        <p>Base Attributes: ${raceData.baseAttributes.join(', ')}</p>
                        <p>Description: ${raceData.description}</p>
                        <p>Active: ${raceData.isActive}</p>
                    </div>
                `;
            } catch (error) {
                console.error('获取种族数据失败：', error);
                alert('Failed to get race data: ' + error.message);
            }
        }

        // 获取职业数据
        async function getClassData() {
            try {
                const classId = document.getElementById('classId').value;
                const classData = await heroMetadataContract.getClass(classId);
                document.getElementById('classResult').innerHTML = `
                    <div class="mt-4 p-4 bg-gray-100 rounded">
                        <p>Base Attributes: ${classData.baseAttributes.join(', ')}</p>
                        <p>Growth Rates: ${classData.growthRates.join(', ')}</p>
                        <p>Description: ${classData.description}</p>
                        <p>Active: ${classData.isActive}</p>
                    </div>
                `;
            } catch (error) {
                console.error('获取职业数据失败：', error);
                alert('Failed to get class data: ' + error.message);
            }
        }

        // 获取技能数据
        async function getSkillData() {
            try {
                const seasonId = document.getElementById('seasonId').value;
                const skillId = document.getElementById('skillId').value;
                const skillLevel = document.getElementById('skillLevel').value;
                const skillData = await heroMetadataContract.getSkill(seasonId, skillId, skillLevel);
                document.getElementById('skillResult').innerHTML = `
                    <div class="mt-4 p-4 bg-gray-100 rounded">
                        <p>Name: ${skillData.name}</p>
                        <p>Points: ${skillData.points}</p>
                        <p>Active: ${skillData.isActive}</p>
                    </div>
                `;
            } catch (error) {
                console.error('获取技能数据失败：', error);
                alert('Failed to get skill data: ' + error.message);
            }
        }

        // 创建新英雄
        async function createNewHero() {
            try {
                const name = document.getElementById('heroName').value;
                if (!name) {
                    throw new Error('请输入英雄名称');
                }
                const race = document.getElementById('createRaceId').value;
                const classId = document.getElementById('createClassId').value;
                
                // 检查网络
                const network = await provider.getNetwork();
                console.log('Current network:', network);
                
                // 检查合约地址
                console.log('Hero contract address:', heroConfig.ethereum.contracts.hero);
                
                // 检查用户地址
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                console.log('User address:', accounts[0]);

                // 检查合约状态
                try {
                    const signer = await provider.getSigner();
                    const signerAddress = await signer.getAddress();
                    console.log('Signer address:', signerAddress);

                    // 重新连接合约
                    const connectedContract = heroContract.connect(signer);
                    console.log('Contract connected with signer');

                    // 准备参数
                    const raceValue = Number(race);
                    const classValue = Number(classId);
                    console.log('Parameters:', {
                        name,
                        race: raceValue,
                        class: classValue
                    });

                    // 发送交易
                    const tx = await connectedContract.createHero(
                        name,
                        raceValue,
                        classValue,
                        {
                            gasLimit: 500000
                        }
                    );
                    
                    console.log('Transaction sent:', tx);
                    
                    document.getElementById('createResult').innerHTML = `
                        <div class="mt-4 p-4 bg-green-100 rounded">
                            <p>Transaction sent! Hash: ${tx.hash}</p>
                            <p>Waiting for confirmation...</p>
                        </div>
                    `;
                    
                    // 等待交易确认
                    const receipt = await tx.wait();
                    console.log('Transaction receipt:', receipt);
                    
                    // 从事件中获取英雄 ID
                    const event = receipt.events.find(e => e.event === 'HeroCreated');
                    const heroId = event.args.heroId;
                    
                    document.getElementById('createResult').innerHTML = `
                        <div class="mt-4 p-4 bg-green-100 rounded">
                            <p>Hero created successfully!</p>
                            <p>Hero ID: ${heroId}</p>
                            <p>Transaction: <a href="https://sepolia-optimism.etherscan.io/tx/${tx.hash}" target="_blank" class="text-blue-600 hover:text-blue-800">View on Etherscan</a></p>
                        </div>
                    `;
                } catch (error) {
                    console.error('Contract interaction failed:', error);
                    throw error;
                }
            } catch (error) {
                console.error('创建英雄失败：', error);
                
                // 解析错误信息
                let errorMessage = error.message;
                if (error.data) {
                    errorMessage += `\nError data: ${JSON.stringify(error.data)}`;
                }
                if (error.transaction) {
                    errorMessage += `\nTransaction: ${JSON.stringify(error.transaction)}`;
                }
                
                document.getElementById('createResult').innerHTML = `
                    <div class="mt-4 p-4 bg-red-100 rounded">
                        <p>Failed to create hero:</p>
                        <pre class="mt-2 text-sm text-red-600 whitespace-pre-wrap">${errorMessage}</pre>
                    </div>
                `;
            }
        }

        // 将函数暴露到全局作用域
        window.connectWallet = connectWallet;
        window.getRaceData = getRaceData;
        window.getClassData = getClassData;
        window.getSkillData = getSkillData;
        window.createNewHero = createNewHero;
    </script>
</head>
<body class="bg-gray-100">
    <div class="header">
        <div class="container">
            <div class="nav-links">
                <a href="/" id="backToHome">返回首页</a>
                <select id="languageSelect" class="language-select">
                    <option value="en">English</option>
                    <option value="zh">中文</option>
                    <option value="th">ไทย</option>
                </select>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4">
        <!-- 顶部区域：钱包连接 -->
        <div class="mb-4 bg-white rounded-lg shadow p-4">
            <h2 id="walletTitle" class="text-lg font-semibold mb-2">钱包连接</h2>
            <button id="connectWallet" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                连接钱包
            </button>
            <div id="connectedWallet" class="hidden">
                <span class="text-green-500 text-sm">已连接</span>
                <span id="walletAddress" class="ml-2 text-gray-600 text-sm"></span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- 左侧：数据查询区域 -->
            <div class="space-y-4">
                <!-- 种族数据测试 -->
                <div class="bg-white rounded-lg shadow p-4">
                    <h2 id="raceTitle" class="text-lg font-semibold mb-2">种族数据测试</h2>
                    <div class="space-y-2">
                        <div>
                            <label for="raceId" class="block text-sm font-medium text-gray-700">选择种族</label>
                            <select id="raceId" class="mt-1 block w-full pl-3 pr-10 py-1 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                <option value="0">Human</option>
                                <option value="1">Elf</option>
                                <option value="2">Dwarf</option>
                                <option value="3">Orc</option>
                                <option value="4">Undead</option>
                            </select>
                        </div>
                        <button id="getRaceData" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 requires-wallet text-sm" disabled>
                            获取数据
                        </button>
                        <div id="raceResult"></div>
                    </div>
                </div>

                <!-- 职业数据测试 -->
                <div class="bg-white rounded-lg shadow p-4">
                    <h2 id="classTitle" class="text-lg font-semibold mb-2">职业数据测试</h2>
                    <div class="space-y-2">
                        <div>
                            <label for="classId" class="block text-sm font-medium text-gray-700">选择职业</label>
                            <select id="classId" class="mt-1 block w-full pl-3 pr-10 py-1 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                <option value="0">Warrior</option>
                                <option value="1">Mage</option>
                                <option value="2">Archer</option>
                                <option value="3">Rogue</option>
                                <option value="4">Priest</option>
                            </select>
                        </div>
                        <button id="getClassData" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 requires-wallet text-sm" disabled>
                            获取数据
                        </button>
                        <div id="classResult"></div>
                    </div>
                </div>

                <!-- 技能数据测试 -->
                <div class="bg-white rounded-lg shadow p-4">
                    <h2 id="skillTitle" class="text-lg font-semibold mb-2">技能数据测试</h2>
                    <div class="space-y-2">
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label for="seasonId" class="block text-sm font-medium text-gray-700">选择季节</label>
                                <select id="seasonId" class="mt-1 block w-full pl-2 pr-8 py-1 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                                    <option value="0">Spring</option>
                                    <option value="1">Summer</option>
                                    <option value="2">Autumn</option>
                                    <option value="3">Winter</option>
                                </select>
                            </div>
                            <div>
                                <label for="skillId" class="block text-sm font-medium text-gray-700">技能 ID</label>
                                <input type="number" id="skillId" min="0" max="4" value="0" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                            </div>
                            <div>
                                <label for="skillLevel" class="block text-sm font-medium text-gray-700">等级</label>
                                <input type="number" id="skillLevel" min="1" max="10" value="1" class="mt-1 block w-full pl-2 pr-2 py-1 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                            </div>
                        </div>
                        <button id="getSkillData" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 requires-wallet text-sm" disabled>
                            获取数据
                        </button>
                        <div id="skillResult"></div>
                    </div>
                </div>
            </div>

            <!-- 右侧：创建英雄区域 -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2 id="creationTitle" class="text-lg font-semibold mb-2">创建英雄</h2>
                <div class="space-y-2">
                    <div>
                        <label for="heroName" class="block text-sm font-medium text-gray-700">英雄名称</label>
                        <input type="text" id="heroName" class="mt-1 block w-full pl-3 pr-10 py-1 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                    </div>
                    <div>
                        <label for="createRaceId" class="block text-sm font-medium text-gray-700">选择种族</label>
                        <select id="createRaceId" class="mt-1 block w-full pl-3 pr-10 py-1 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                            <option value="0">Human</option>
                            <option value="1">Elf</option>
                            <option value="2">Dwarf</option>
                            <option value="3">Orc</option>
                            <option value="4">Undead</option>
                        </select>
                    </div>
                    <div>
                        <label for="createClassId" class="block text-sm font-medium text-gray-700">选择职业</label>
                        <select id="createClassId" class="mt-1 block w-full pl-3 pr-10 py-1 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md">
                            <option value="0">Warrior</option>
                            <option value="1">Mage</option>
                            <option value="2">Archer</option>
                            <option value="3">Rogue</option>
                            <option value="4">Priest</option>
                        </select>
                    </div>
                    <button id="createHero" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 requires-wallet text-sm" disabled>
                        创建英雄
                    </button>
                    <div id="createResult"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 