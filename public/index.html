<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>节点注册 - Arcadia Node</title>
    <link rel="stylesheet" href="/css/common.css">
    <script src="/node_modules/ethers/dist/ethers.umd.min.js"></script>
    <style>
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
        }
        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        .text-muted {
            color: #666;
            font-size: 0.875rem;
        }
        .loading {
            color: #2196F3;
            padding: 1rem;
            background: #E3F2FD;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .error {
            color: #D32F2F;
            padding: 1rem;
            background: #FFEBEE;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .success {
            color: #388E3C;
            padding: 1rem;
            background: #E8F5E9;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .info {
            color: #1976D2;
            padding: 1rem;
            background: #E3F2FD;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .info pre {
            background: white;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        .info h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }
    </style>
    <script>
        // 检查 ethers 是否加载成功
            if (typeof ethers === 'undefined') {
            console.error('ethers library not loaded');
            document.getElementById('error').textContent = 'Error: ethers library not loaded';
        }

        const provider = new ethers.JsonRpcProvider('https://sepolia.optimism.io');
        const contractAddress = '0x6C9c5ce574f160a45a6b8c7bb108f2a31b97f409';
        const contractABI = [
            "function registerNode(address nodeAddress, string memory nodeUrl, string memory nodeType) external",
            "function isNodeRegistered(address nodeAddress) external view returns (bool)"
        ];

        let contract;
        let signer;

        async function init() {
            try {
                if (!window.ethereum) {
                    throw new Error('MetaMask not installed');
                }

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Create Web3Provider and get signer
                const web3Provider = new ethers.BrowserProvider(window.ethereum);
                signer = await web3Provider.getSigner();
                
                // Create contract instance
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                
                // Update UI to show connected account
                document.getElementById('connected-account').textContent = `Connected Account: ${accounts[0]}`;
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('error').textContent = `Error: ${error.message}`;
            }
        }

        async function registerNode() {
            const resultDiv = document.getElementById('result');
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const infoDiv = document.getElementById('info');
            
            try {
                // Clear previous messages
                resultDiv.innerHTML = '';
                loadingDiv.innerHTML = '';
                errorDiv.innerHTML = '';
                infoDiv.innerHTML = '';
                
                // Get form values
                const nodeAddress = document.getElementById('nodeAddress').value;
                const nodeUrl = document.getElementById('nodeUrl').value;
                const nodeType = document.getElementById('nodeType').value;
                
                // Validate inputs
                if (!nodeAddress || !nodeUrl || !nodeType) {
                    throw new Error('Please fill in all fields');
                }
                
                if (!ethers.isAddress(nodeAddress)) {
                    throw new Error('Invalid node address format');
                }
                
                // Show loading message
                loadingDiv.innerHTML = '<div class="loading">Registering node... Please wait and approve the transaction in MetaMask.</div>';
                
                // Display the data being sent
                infoDiv.innerHTML = `
                    <div class="info">
                        <h3>Sending Registration Data:</h3>
                        <pre>${JSON.stringify({
                            nodeAddress,
                            nodeUrl,
                            nodeType
                        }, null, 2)}</pre>
                    </div>
                `;
                
                // Check if node is already registered
                const isRegistered = await contract.isNodeRegistered(nodeAddress);
                if (isRegistered) {
                    throw new Error('Node is already registered');
                }
                
                // Send transaction
                const tx = await contract.registerNode(nodeAddress, nodeUrl, nodeType);
                
                // Show transaction hash
                infoDiv.innerHTML += `
                    <div class="info">
                        <h3>Transaction Sent:</h3>
                        <pre>Transaction Hash: ${tx.hash}</pre>
                    </div>
                `;
                
                // Wait for transaction to be mined
                const receipt = await tx.wait();
                
                // Show success message
                resultDiv.innerHTML = `
                    <div class="success">
                        Node successfully registered!
                        <br>
                        Transaction Hash: ${receipt.hash}
                        <br>
                        Block Number: ${receipt.blockNumber}
                    </div>
                `;
                
            } catch (error) {
                console.error('Registration error:', error);
                errorDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            } finally {
                loadingDiv.innerHTML = ''; // Clear loading message
            }
        }

        // Initialize when page loads
        window.addEventListener('load', init);
    </script>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Register Node</h1>
            <div id="connected-account" class="text-muted"></div>
            
            <form onsubmit="event.preventDefault(); registerNode();">
                <div class="form-group">
                    <label for="nodeAddress">Node Address:</label>
                    <input type="text" id="nodeAddress" class="form-control" placeholder="0x..." required>
                </div>
                
                <div class="form-group">
                    <label for="nodeUrl">Node URL:</label>
                    <input type="text" id="nodeUrl" class="form-control" placeholder="https://..." required>
                </div>
                
                <div class="form-group">
                    <label for="nodeType">Node Type:</label>
                    <select id="nodeType" class="form-control" required>
                        <option value="">Select a node type...</option>
                        <option value="validator">Validator</option>
                        <option value="executor">Executor</option>
                    </select>
                </div>
                
                <button type="submit" class="btn">Register Node</button>
            </form>
            
            <div id="loading"></div>
            <div id="error"></div>
            <div id="info"></div>
            <div id="result"></div>
        </div>
    </div>

    <script>
        let registryWallet = null;  // 注册服务节点的钱包
        let newNodeWallet = null;   // 新节点的钱包
        let provider = null;
        let nodeRegistryContract = null;

        // 初始化 ethers
        async function initEthers() {
            try {
                console.log('Initializing ethers...');
                // 从环境变量获取注册服务节点的私钥
                const response = await fetch('/api/v1/env/get', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        key: 'NODE_PRIVATE_KEY'
                    })
                });
                
                console.log('Response status:', response.status);
                const responseText = await response.text();
                console.log('Response text:', responseText);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch NODE_PRIVATE_KEY: ${response.status} ${responseText}`);
                }
                
                const data = JSON.parse(responseText);
                console.log('Parsed response:', data);
                
                if (data.code === 0 && data.value) {
                    // 使用 Optimism Sepolia 网络
                    provider = new ethers.providers.JsonRpcProvider('https://sepolia.optimism.io');
                    registryWallet = new ethers.Wallet(data.value, provider);
                    console.log('Wallet initialized with address:', registryWallet.address);
                    
                    // 获取合约地址
                    const contractResponse = await fetch('/api/v1/env/get', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            key: 'NODE_REGISTRY_ADDRESS'
                        })
                    });
                    
                    if (!contractResponse.ok) {
                        throw new Error('Failed to fetch NODE_REGISTRY_ADDRESS');
                    }
                    
                    const contractData = await contractResponse.json();
                    console.log('Contract data:', contractData);
                    
                    if (contractData.code === 0 && contractData.value) {
                        // 初始化合约
                        const abi = [
                            "function registerNode(address nodeAddress, string memory ipOrDomain, string memory apiIndexes) external",
                            "function getNodeInfo(address nodeAddress) external view returns (string memory ipOrDomain, string memory apiIndexes, bool isActive)"
                        ];
                        nodeRegistryContract = new ethers.Contract(contractData.value, abi, registryWallet);
                        console.log('Contract initialized at:', contractData.value);
                    }

                    // 生成第一个新节点密钥对
                    generateNewKeypair();
                } else {
                    throw new Error('Invalid response format or missing value');
                }
            } catch (error) {
                console.error('初始化失败：', error);
                throw error;
            }
        }

        // 生成新的密钥对
        function generateNewKeypair() {
            try {
                // 生成新的随机钱包
                newNodeWallet = ethers.Wallet.createRandom();
                
                // 显示新节点信息
                document.getElementById('nodeAddress').value = newNodeWallet.address;
                document.getElementById('nodeUrl').value = 'node.cmuba.org';
                document.getElementById('nodeType').value = 'validator';
                
                // 清空之前的结果
                document.getElementById('loading').textContent = '';
                document.getElementById('error').textContent = '';
                document.getElementById('info').textContent = '';
                document.getElementById('result').textContent = '';
            } catch (error) {
                console.error('生成密钥对失败：', error);
            }
        }

        // 注册节点
        async function registerNode() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="loading">正在注册节点...</div>';
            
            try {
                if (!registryWallet) {
                    throw new Error('注册服务节点未初始化');
                }

                if (!newNodeWallet) {
                    throw new Error('请先生成新节点密钥对');
                }

                const nodeAddress = document.getElementById('nodeAddress').value;
                const nodeUrl = document.getElementById('nodeUrl').value;
                const nodeType = document.getElementById('nodeType').value;

                if (!nodeAddress || !nodeUrl || !nodeType) {
                    throw new Error('请填写所有必要信息');
                }

                // 显示发送的数据
                resultDiv.innerHTML += `
                    <div class="info">
                        <h3>发送的数据：</h3>
                        <pre>
节点地址：${nodeAddress}
节点域名：${nodeUrl}
节点类型：${nodeType}
                        </pre>
                    </div>
                `;

                // 发送注册请求
                const response = await fetch('/api/v1/node/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        nodeAddress,
                        ipOrDomain: nodeUrl,
                        apiIndexes: '[1,2,3,4,5,6,7,8,9,10,11,12,13]',
                        nodeType
                    })
                });

                const responseText = await response.text();
                console.log('Register response:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`服务器响应解析失败：${responseText}`);
                }

                // 显示返回的数据
                resultDiv.innerHTML += `
                    <div class="info">
                        <h3>服务器响应：</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;

                if (response.ok && data.code === 0) {
                    // 保存新注册的地址到本地存储
                    const recentAddresses = JSON.parse(localStorage.getItem('recentAddresses') || '[]');
                    if (!recentAddresses.includes(nodeAddress)) {
                        recentAddresses.push(nodeAddress);
                        localStorage.setItem('recentAddresses', JSON.stringify(recentAddresses));
                    }

                    resultDiv.innerHTML += '<div class="success">节点注册成功！</div>';
                } else {
                    throw new Error(data.message || '注册失败');
                }
            } catch (error) {
                console.error('注册节点失败：', error);
                resultDiv.innerHTML += `<div class="error">注册失败：${error.message}</div>`;
            }
        }

        // 修改页面加载初始化
        window.onload = function() {
            initEthers();
            // 设置默认值
            document.getElementById('nodeUrl').value = 'node.cmuba.org';
            // 生成第一个新节点密钥对
            generateNewKeypair();
        };
    </script>
</body>
</html> 