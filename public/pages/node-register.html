<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>节点注册 - Arcadia Node</title>
    <link rel="stylesheet" href="/css/common.css">
    <script src="/js/ethers.umd.min.js"></script>
    <script>
        // 检查 ethers 是否加载成功
        window.addEventListener('load', function() {
            if (typeof ethers === 'undefined') {
                console.error('ethers.js 加载失败');
                alert('Error: ethers.js 加载失败，请检查网络连接后刷新页面');
            } else {
                console.log('ethers.js 加载成功');
                initEthers().catch(console.error);
            }
        });
    </script>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>节点注册</h1>
            <a href="/" class="back-link">返回首页</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>新节点信息</h2>
            <div class="form-group">
                <label for="newNodeAddress">新节点地址：</label>
                <input type="text" id="newNodeAddress" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="newNodePrivateKey">新节点私钥：</label>
                <input type="text" id="newNodePrivateKey" class="form-control" readonly>
                <small class="text-muted">请保存此私钥，它只会显示一次！</small>
            </div>
            <div class="form-group">
                <label for="nodeEndpoint">节点 IP/域名：</label>
                <input type="text" id="nodeEndpoint" class="form-control" placeholder="例如: https://example.com" value="node.cmuba.org">
            </div>
            <div class="form-group">
                <label for="nodeApis">API 索引：</label>
                <input type="text" id="nodeApis" class="form-control" placeholder="例如: [1,2,3,4,5]" value="[1,2,3,4,5,6,7,8,9,10,11,12,13]">
            </div>
            <div class="form-group">
                <label for="nodeEns">节点 ENS：</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="nodeEns" class="form-control" placeholder="TODO" readonly style="background-color: #f5f5f5;">
                    <button class="btn" onclick="getENS()">获取 ENS</button>
                </div>
            </div>
            <button class="btn" onclick="generateNewKeypair()">生成新密钥对</button>
        </div>

        <div class="card">
            <h2>获取 Challenge</h2>
            <button class="btn" onclick="getChallenge()">获取 Challenge</button>
            <div id="challengeResult" class="result"></div>
        </div>

        <div class="card">
            <h2>签名 Challenge</h2>
            <div class="form-group">
                <label for="challenge">Challenge：</label>
                <input type="text" id="challenge" class="form-control" readonly>
            </div>
            <button class="btn" onclick="signChallenge()">签名 Challenge</button>
            <div id="signResult" class="result"></div>
        </div>

        <div class="card">
            <h2>注册节点</h2>
            <div class="form-group">
                <label for="signature">签名：</label>
                <input type="text" id="signature" class="form-control" readonly>
            </div>
            <button class="btn" onclick="registerNode()">注册节点</button>
            <div id="registerResult" class="result"></div>
        </div>

        <!-- 新增：请求和响应信息显示区域 -->
        <div class="card" id="requestResponseCard" style="display: none;">
            <h2>请求和响应信息</h2>
            <div class="info-section">
                <h3>请求信息</h3>
                <pre id="requestInfo" class="code-block"></pre>
            </div>
            <div class="info-section">
                <h3>响应信息</h3>
                <pre id="responseInfo" class="code-block"></pre>
            </div>
        </div>
    </div>

    <style>
        /* 添加新的样式 */
        .info-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .info-section h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }
        .code-block {
            background: #fff;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            overflow-x: auto;
            margin: 0;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success-message {
            color: #4CAF50;
            font-weight: bold;
        }
        .error-message {
            color: #f44336;
            font-weight: bold;
        }
    </style>

    <script>
        let registryWallet = null;  // 注册服务节点的钱包
        let newNodeWallet = null;   // 新节点的钱包
        let provider = null;
        let nodeRegistryContract = null;

        // 初始化 ethers
        async function initEthers() {
            try {
                console.log('Initializing ethers...');
                // 从环境变量获取注册服务节点的私钥
                const response = await fetch('/api/v1/env/get', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        key: 'NODE_PRIVATE_KEY'
                    })
                });
                
                console.log('Response status:', response.status);
                const responseText = await response.text();
                console.log('Response text:', responseText);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch NODE_PRIVATE_KEY: ${response.status} ${responseText}`);
                }
                
                const data = JSON.parse(responseText);
                console.log('Parsed response:', data);
                
                if (data.code === 0 && data.value) {
                    // 获取 RPC URL
                    const rpcResponse = await fetch('/api/v1/env/get', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            key: 'OPTIMISM_TESTNET_RPC_URL'
                        })
                    });

                    if (!rpcResponse.ok) {
                        throw new Error('Failed to fetch RPC URL');
                    }

                    const rpcData = await rpcResponse.json();
                    if (rpcData.code !== 0 || !rpcData.value) {
                        throw new Error('Invalid RPC URL response');
                    }

                    // 使用 Optimism Sepolia 网络
                    provider = new ethers.JsonRpcProvider(rpcData.value);
                    registryWallet = new ethers.Wallet(data.value, provider);
                    console.log('Wallet initialized with address:', registryWallet.address);
                    
                    // 获取合约地址
                    const contractResponse = await fetch('/api/v1/env/get', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            key: 'NODE_REGISTRY_ADDRESS'
                        })
                    });
                    
                    if (!contractResponse.ok) {
                        throw new Error('Failed to fetch NODE_REGISTRY_ADDRESS');
                    }
                    
                    const contractData = await contractResponse.json();
                    console.log('Contract data:', contractData);
                    
                    if (contractData.code === 0 && contractData.value) {
                        // 初始化合约
                        const abi = [
                            "function registerNode(address nodeAddress, string memory ipOrDomain, string memory apiIndexes, bytes32 challenge, bytes memory signature) external",
                            "function getNodeInfo(address nodeAddress) external view returns (tuple(string ipOrDomain, string apiIndexes, uint256 registeredAt))"
                        ];
                        nodeRegistryContract = new ethers.Contract(contractData.value, abi, registryWallet);
                        console.log('Contract initialized at:', contractData.value);
                    }

                    // 生成第一个新节点密钥对
                    generateNewKeypair();
                } else {
                    throw new Error('Invalid response format or missing value');
                }
            } catch (error) {
                console.error('初始化失败:', error);
                throw error;
            }
        }

        // 生成新的密钥对
        function generateNewKeypair() {
            try {
                // 生成新的随机钱包
                newNodeWallet = ethers.Wallet.createRandom();
                
                // 显示新节点信息
                document.getElementById('newNodeAddress').value = newNodeWallet.address;
                document.getElementById('newNodePrivateKey').value = newNodeWallet.privateKey;
                
                // 清空之前的结果
                document.getElementById('challenge').value = '';
                document.getElementById('signature').value = '';
                document.getElementById('challengeResult').textContent = '';
                document.getElementById('signResult').textContent = '';
                document.getElementById('registerResult').textContent = '';
                document.getElementById('nodeEns').value = '';
            } catch (error) {
                console.error('生成密钥对失败:', error);
            }
        }

        // 获取 Challenge
        async function getChallenge() {
            try {
                const response = await fetch('/api/v1/node/get-challenge', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.code === 0 && data.data && data.data.challenge) {
                    document.getElementById('challenge').value = data.data.challenge;
                    document.getElementById('challengeResult').textContent = '获取 Challenge 成功';
                } else {
                    document.getElementById('challengeResult').textContent = '获取 Challenge 失败: ' + (data.message || '未知错误');
                }
            } catch (error) {
                document.getElementById('challengeResult').textContent = 'Error: ' + error.message;
            }
        }

        // 签名 Challenge
        async function signChallenge() {
            try {
                const challenge = document.getElementById('challenge').value;
                if (!challenge) {
                    throw new Error('请先获取 Challenge');
                }

                if (!newNodeWallet) {
                    throw new Error('请先生成新节点密钥对');
                }

                // 使用新节点的私钥签名
                const signature = await newNodeWallet.signMessage(challenge);
                
                document.getElementById('signature').value = signature;
                document.getElementById('signResult').textContent = '签名成功';
            } catch (error) {
                document.getElementById('signResult').textContent = 'Error: ' + error.message;
            }
        }

        // 注册节点
        async function registerNode() {
            try {
                if (!registryWallet) {
                    throw new Error('注册服务节点未初始化');
                }

                if (!newNodeWallet) {
                    throw new Error('请先生成新节点密钥对');
                }

                const nodeAddress = document.getElementById('newNodeAddress').value;
                const nodeEndpoint = document.getElementById('nodeEndpoint').value;
                const nodeApis = document.getElementById('nodeApis').value;
                const challenge = document.getElementById('challenge').value;
                const signature = document.getElementById('signature').value;
                const nodeEns = document.getElementById('nodeEns').value;

                if (!nodeAddress || !nodeEndpoint || !nodeApis || !challenge || !signature) {
                    throw new Error('请填写所有必要信息');
                }

                // 构建请求数据
                const requestData = {
                    node_address: nodeAddress,
                    node_url: nodeEndpoint,
                    api_url: `${nodeEndpoint}/api/v1`,
                    node_ens: nodeEns || '',
                    node_ip: '',
                    node_service_list: nodeApis,
                    registry_contract_address: nodeRegistryContract.address,
                    challenge,
                    signature
                };

                // 显示请求信息
                document.getElementById('requestResponseCard').style.display = 'block';
                document.getElementById('requestInfo').textContent = JSON.stringify(requestData, null, 2);

                // 发送注册请求
                const response = await fetch('/api/v1/node/register', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Registry-Address': registryWallet.address
                    },
                    body: JSON.stringify(requestData)
                });

                const responseData = await response.json();

                // 显示响应信息
                document.getElementById('responseInfo').textContent = JSON.stringify(responseData, null, 2);

                // 更新注册结果显示
                const registerResult = document.getElementById('registerResult');
                if (response.ok && responseData.code === 0) {
                    registerResult.innerHTML = `
                        <div class="success-message">
                            注册成功！<br>
                            节点地址: ${nodeAddress}<br>
                            请保存新节点私钥：${newNodeWallet.privateKey}
                        </div>
                    `;

                    // 保存新注册的地址到本地存储
                    const recentAddresses = JSON.parse(localStorage.getItem('recentAddresses') || '[]');
                    if (!recentAddresses.includes(nodeAddress)) {
                        recentAddresses.push(nodeAddress);
                        localStorage.setItem('recentAddresses', JSON.stringify(recentAddresses));
                    }

                    // 添加交易链接
                    const txHash = responseData.tx_hash; // 假设后端返回了交易哈希
                    registerResult.innerHTML += `
                        <div class="transaction-info">
                            <p>交易哈希: ${txHash}</p>
                            <p>查看交易: <a href="https://sepolia-optimism.etherscan.io/tx/${txHash}" target="_blank">Etherscan</a></p>
                        </div>
                    `;
                } else {
                    registerResult.innerHTML = `
                        <div class="error-message">
                            注册失败：${responseData.message || '未知错误'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('注册节点失败：', error);
                document.getElementById('registerResult').innerHTML = `
                    <div class="error-message">
                        注册失败：${error.message}
                    </div>
                `;
                document.getElementById('responseInfo').textContent = `Error: ${error.message}`;
            }
        }

        // 获取 ENS
        async function getENS() {
            try {
                const address = document.getElementById('newNodeAddress').value;
                if (!address) {
                    throw new Error('请先生成节点地址');
                }

                // 这里添加获取 ENS 的逻辑
                const response = await fetch('/api/v1/node/ens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });
                
                const data = await response.json();
                if (data.code === 0 && data.ens) {
                    document.getElementById('nodeEns').value = data.ens;
                } else {
                    throw new Error(data.message || '获取 ENS 失败');
                }
            } catch (error) {
                alert('获取 ENS 失败: ' + error.message);
            }
        }

        // 修改页面加载初始化
        window.onload = function() {
            initEthers();
            // 设置默认值
            document.getElementById('nodeEndpoint').value = 'node.cmuba.org';
            document.getElementById('nodeApis').value = '[1,2,3,4,5,6,7,8,9,10,11,12,13]';
            // 生成第一个新节点密钥对
            generateNewKeypair();
        };
    </script>
</body>
</html> 