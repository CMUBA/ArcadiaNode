<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>节点注册 - Arcadia Node</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js" type="application/javascript"></script>
    <link rel="stylesheet" href="/css/common.css">
    <style>
        .registration-flow {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .step {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #e3f2fd;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
        }
        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background-color: #1565c0;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>节点注册</h1>
            <a href="/" class="back-link">返回首页</a>
        </div>
    </div>

    <div class="container">
        <div class="registration-flow">
            <div class="step">
                <h3>1. 获取挑战字符串</h3>
                <button class="btn" onclick="getChallenge()">获取挑战字符串</button>
                <div id="challengeResult" class="result"></div>
            </div>

            <div class="step">
                <h3>2. 签名挑战</h3>
                <div class="form-group">
                    <label for="challengeToSign">挑战字符串：</label>
                    <input type="text" id="challengeToSign" class="form-control" placeholder="输入挑战字符串">
                </div>
                <button class="btn" onclick="signChallenge()">签名</button>
                <div id="signResult" class="result"></div>
            </div>

            <div class="step">
                <h3>3. 注册节点</h3>
                <div class="form-group">
                    <label for="nodeAddress">节点地址：</label>
                    <input type="text" id="nodeAddress" class="form-control" placeholder="节点地址">
                </div>
                <div class="form-group">
                    <label for="nodeUrl">节点URL：</label>
                    <input type="text" id="nodeUrl" class="form-control" placeholder="节点URL">
                </div>
                <div class="form-group">
                    <label for="apiUrl">API URL：</label>
                    <input type="text" id="apiUrl" class="form-control" placeholder="API URL">
                </div>
                <div class="form-group">
                    <label for="nodeEns">节点ENS：</label>
                    <input type="text" id="nodeEns" class="form-control" placeholder="节点ENS">
                </div>
                <div class="form-group">
                    <label for="nodeIp">节点IP：</label>
                    <input type="text" id="nodeIp" class="form-control" placeholder="节点IP">
                </div>
                <div class="form-group">
                    <label for="challenge">挑战字符串：</label>
                    <input type="text" id="challenge" class="form-control" placeholder="挑战字符串">
                </div>
                <div class="form-group">
                    <label for="signature">签名：</label>
                    <input type="text" id="signature" class="form-control" placeholder="签名">
                </div>
                <button class="btn" onclick="registerNode()">注册</button>
                <div id="registerResult" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        // 从环境变量获取合约地址
        const NODE_REGISTRY_CONTRACT_ADDRESS = process.env.NODE_REGISTRY_CONTRACT_ADDRESS;

        // 默认参数
        const defaultParams = {
            node_register: {
                node_address: "",
                node_url: "https://node.cmuba.org",
                api_url: "https://node.cmuba.org/api/v1",
                node_ens: "node1.asset3.eth",
                node_ip: "127.0.0.1",
                node_service_list: JSON.stringify([1, 2, 3, 4, 5]),
                registry_contract_address: NODE_REGISTRY_CONTRACT_ADDRESS,
                challenge: "",
                signature: ""
            }
        };

        async function getChallenge() {
            try {
                const response = await fetch('/api/v1/node/get-challenge', {
                    method: 'GET'
                });
                const data = await response.json();
                document.getElementById('challengeResult').textContent = JSON.stringify(data, null, 2);
                document.getElementById('challengeToSign').value = data.challenge;
            } catch (error) {
                document.getElementById('challengeResult').textContent = 'Error: ' + error.message;
            }
        }

        async function signChallenge() {
            try {
                const challenge = document.getElementById('challengeToSign').value;
                const response = await fetch('/api/v1/node/sign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        challenge: challenge
                    })
                });
                const data = await response.json();
                document.getElementById('signResult').textContent = JSON.stringify(data, null, 2);
                document.getElementById('signature').value = data.signature;
                document.getElementById('challenge').value = challenge;
                if (data.address) {
                    document.getElementById('nodeAddress').value = data.address;
                }
            } catch (error) {
                document.getElementById('signResult').textContent = 'Error: ' + error.message;
            }
        }

        async function registerNode() {
            try {
                const params = {
                    node_address: document.getElementById('nodeAddress').value,
                    node_url: document.getElementById('nodeUrl').value,
                    api_url: document.getElementById('apiUrl').value,
                    node_ens: document.getElementById('nodeEns').value,
                    node_ip: document.getElementById('nodeIp').value,
                    node_service_list: defaultParams.node_register.node_service_list,
                    registry_contract_address: NODE_REGISTRY_CONTRACT_ADDRESS,
                    challenge: document.getElementById('challenge').value,
                    signature: document.getElementById('signature').value
                };

                const response = await fetch('/api/v1/node/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });
                const data = await response.json();
                document.getElementById('registerResult').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('registerResult').textContent = 'Error: ' + error.message;
            }
        }

        // 页面加载时填充默认值
        window.onload = function() {
            document.getElementById('nodeUrl').value = defaultParams.node_register.node_url;
            document.getElementById('apiUrl').value = defaultParams.node_register.api_url;
            document.getElementById('nodeEns').value = defaultParams.node_register.node_ens;
            document.getElementById('nodeIp').value = defaultParams.node_register.node_ip;
        };
    </script>
</body>
</html> 