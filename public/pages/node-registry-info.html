<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>节点注册合约信息 - Arcadia Node</title>
    <link rel="stylesheet" href="/css/common.css">
    <style>
        .node-list {
            margin-top: 20px;
        }
        .node-item {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .node-item h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .node-detail {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
            margin-bottom: 5px;
        }
        .node-detail .label {
            font-weight: bold;
            color: #666;
        }
        .node-detail .value {
            word-break: break-all;
        }
        .refresh-btn {
            margin-bottom: 20px;
        }
        .search-section {
            margin: 20px 0;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        .search-form {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .search-form input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-form button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .search-form button:hover {
            background: #45a049;
        }
        .error {
            color: #f44336;
            padding: 10px;
            margin: 10px 0;
            background: #ffebee;
            border-radius: 4px;
        }
        .no-nodes {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>节点注册合约信息</h1>
            <a href="/" class="back-link">返回首页</a>
        </div>
    </div>

    <div class="container">
        <h1>节点注册信息</h1>
        <div class="info-section">
            <p>合约地址：<span id="contractAddress">0x0000000000000000000000000000000000000000</span></p>
            <p>状态：<span id="status">正在连接...</span></p>
        </div>
        
        <div class="search-section">
            <h2>查询节点信息</h2>
            <div class="search-form">
                <input type="text" id="nodeAddress" placeholder="输入节点地址" />
                <button onclick="checkNodeAddress()">查询</button>
            </div>
        </div>

        <div class="node-list-section">
            <h2>已注册节点列表</h2>
            <button onclick="refreshNodeList()">刷新节点列表</button>
            <div id="nodeList" class="node-list"></div>
        </div>
    </div>

    <script src="/node_modules/ethers/dist/ethers.umd.min.js"></script>
    <script>
        let provider;
        let contract;
        const nodeRegistryAbi = [
            {
                "inputs": [],
                "name": "MIN_STAKE_AMOUNT",
                "outputs": [{"name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"name": "nodeAddress", "type": "address"}],
                "name": "getNodeInfo",
                "outputs": [
                    {"name": "ipOrDomain", "type": "string"},
                    {"name": "apiIndexes", "type": "string"},
                    {"name": "registeredAt", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"name": "nodeAddress", "type": "address"}],
                "name": "isRegistered",
                "outputs": [{"name": "", "type": "bool"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"name": "", "type": "address"}],
                "name": "nodes",
                "outputs": [
                    {"name": "ipOrDomain", "type": "string"},
                    {"name": "apiIndexes", "type": "string"},
                    {"name": "registeredAt", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        async function initContract() {
            try {
                console.log('Initializing contract...');
                provider = new ethers.providers.JsonRpcProvider('https://sepolia.optimism.io');
                
                const response = await fetch('/api/v1/env/get', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        key: 'NODE_REGISTRY_ADDRESS'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch contract address');
                }

                const data = await response.json();
                if (data.code === 0 && data.value) {
                    const contractAddress = data.value;
                    console.log('Contract address:', contractAddress);
                    
                    if (!ethers.utils.isAddress(contractAddress)) {
                        throw new Error('Invalid contract address format');
                    }

                    const code = await provider.getCode(contractAddress);
                    console.log('Contract bytecode:', code);
                    if (code === '0x') {
                        throw new Error('No contract found at the specified address');
                    }

                    contract = new ethers.Contract(contractAddress, nodeRegistryAbi, provider);
                    document.getElementById('contractAddress').textContent = contractAddress;

                    try {
                        const stakeAmount = await contract.MIN_STAKE_AMOUNT();
                        console.log('Required stake amount:', ethers.utils.formatEther(stakeAmount), 'ETH');
                    } catch (error) {
                        console.error('Failed to get stake amount:', error);
                    }

                    await refreshNodeList();
                }
            } catch (error) {
                console.error('初始化失败：', error);
                alert('初始化失败：' + error.message);
            }
        }

        async function refreshNodeList() {
            try {
                if (!provider || !contract) {
                    console.error('Provider or contract not initialized');
                    return;
                }

                const nodeList = document.getElementById('nodeList');
                nodeList.innerHTML = '';

                // Get recent addresses from local storage or use defaults
                const recentAddresses = JSON.parse(localStorage.getItem('recentAddresses') || '[]');
                if (recentAddresses.length === 0) {
                    console.log('No recent addresses found');
                    nodeList.innerHTML = '<div class="no-nodes">暂无节点信息</div>';
                    return;
                }

                for (const address of recentAddresses) {
                    try {
                        const isRegistered = await contract.isRegistered(address);
                        if (!isRegistered) {
                            console.log('Address not registered:', address);
                            continue;
                        }

                        const nodeInfo = await contract.getNodeInfo(address);
                        console.log('Node info for', address, ':', nodeInfo);

                        const nodeElement = document.createElement('div');
                        nodeElement.className = 'node-item';
                        nodeElement.innerHTML = `
                            <div class="node-header">
                                <h3>节点信息</h3>
                            </div>
                            <div class="node-details">
                                <div class="node-detail">
                                    <span class="label">地址：</span>
                                    <span class="value">${address}</span>
                                </div>
                                <div class="node-detail">
                                    <span class="label">域名/IP：</span>
                                    <span class="value">${nodeInfo.ipOrDomain}</span>
                                </div>
                                <div class="node-detail">
                                    <span class="label">API 索引：</span>
                                    <span class="value">${nodeInfo.apiIndexes}</span>
                                </div>
                                <div class="node-detail">
                                    <span class="label">注册时间：</span>
                                    <span class="value">${new Date(Number(nodeInfo.registeredAt) * 1000).toLocaleString()}</span>
                                </div>
                            </div>
                        `;
                        nodeList.appendChild(nodeElement);
                    } catch (error) {
                        console.error('Error getting node info for', address, ':', error);
                    }
                }

                if (nodeList.children.length === 0) {
                    nodeList.innerHTML = '<div class="no-nodes">暂无已注册节点</div>';
                }
            } catch (error) {
                console.error('Error refreshing node list:', error);
                document.getElementById('nodeList').innerHTML = '<div class="error">获取节点列表失败</div>';
            }
        }

        // Add function to store recent addresses
        function addRecentAddress(address) {
            let recentAddresses = JSON.parse(localStorage.getItem('recentAddresses') || '[]');
            if (!recentAddresses.includes(address)) {
                recentAddresses.push(address);
                if (recentAddresses.length > 10) { // Keep only last 10 addresses
                    recentAddresses.shift();
                }
                localStorage.setItem('recentAddresses', JSON.stringify(recentAddresses));
            }
        }

        // Initialize the page
        async function initializePage() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    const network = await provider.getNetwork();
                    console.log('Connected to network:', network);

                    const contractAddress = document.getElementById('contractAddress').textContent;
                    if (!ethers.utils.isAddress(contractAddress)) {
                        throw new Error('Invalid contract address');
                    }

                    contract = new ethers.Contract(contractAddress, nodeRegistryAbi, provider);
                    
                    try {
                        const minStakeAmount = await contract.MIN_STAKE_AMOUNT();
                        console.log('Minimum stake amount:', ethers.utils.formatEther(minStakeAmount), 'ETH');
                    } catch (error) {
                        console.error('Error getting minimum stake amount:', error);
                    }

                    await refreshNodeList();
                } else {
                    console.error('Please install MetaMask');
                    document.getElementById('status').textContent = '请安装 MetaMask';
                }
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('status').textContent = '初始化失败';
            }
        }

        // 页面加载时初始化
        window.onload = initializePage;

        async function checkNodeAddress() {
            const addressInput = document.getElementById('nodeAddress');
            const address = addressInput.value.trim();

            if (!address) {
                alert('请输入节点地址');
                return;
            }

            if (!ethers.utils.isAddress(address)) {
                alert('无效的地址格式');
                return;
            }

            try {
                const isRegistered = await contract.isRegistered(address);
                if (!isRegistered) {
                    alert('该地址未注册为节点');
                    return;
                }

                const nodeInfo = await contract.getNodeInfo(address);
                console.log('Node info:', nodeInfo);

                // Add to recent addresses
                addRecentAddress(address);

                // Refresh the list to show the new address
                await refreshNodeList();

                // Clear the input
                addressInput.value = '';
            } catch (error) {
                console.error('Error checking node address:', error);
                alert('查询节点信息失败');
            }
        }
    </script>
</body>
</html> 